//@version=6
indicator("ICT Assistant: Full Visual [Expert]", overlay=true, max_lines_count=500, max_boxes_count=500, max_labels_count=500)

// ==========================================
// 0. TIMEFRAME DETECTION & AUTO-ADAPTATION
// ==========================================
tf_mins = timeframe.in_seconds() / 60

is_scalping = tf_mins <= 5
is_intraday = tf_mins > 5 and tf_mins <= 60
is_swing = tf_mins > 60 and tf_mins <= 240
is_position = tf_mins > 240

auto_pivot_lookback = is_scalping ? 5 : is_intraday ? 10 : is_swing ? 15 : 20
auto_ob_lookback = is_scalping ? 3 : is_intraday ? 5 : is_swing ? 8 : 10
auto_bos_lookback = is_scalping ? 5 : is_intraday ? 8 : is_swing ? 12 : 15

// ==========================================
// 1. CONFIGURATION - DARK MODE OPTIMIZED
// ==========================================
grp_time    = "Time & Session"
useKZ       = input.bool(true, "Filter by Killzones (Intraday only)", group=grp_time)
kz_london   = input.session("0200-0500", "London", group=grp_time)
kz_ny       = input.session("0700-1100", "New York", group=grp_time)
kz_asia     = input.session("2000-0000", "Asian (optional)", group=grp_time)
use_asia_kz = input.bool(false, "Include Asian Session", group=grp_time)

grp_liq     = "Liquidity & Structure"
use_auto_params = input.bool(true, "Auto-adapt to Timeframe", group=grp_liq)
liq_len_manual = input.int(10, "Pivot Lookback (manual)", group=grp_liq, minval=3, maxval=50)
// DARK MODE COLORS - High visibility on black background
col_bsl     = input.color(#FF6B6B, "BSL Color (Red Coral)", group=grp_liq)
col_ssl     = input.color(#4ECDC4, "SSL Color (Cyan)", group=grp_liq)
col_bos_bull = input.color(#00FF88, "BOS Bull Color", group=grp_liq)
col_bos_bear = input.color(#FF4757, "BOS Bear Color", group=grp_liq)

liq_len = use_auto_params ? auto_pivot_lookback : liq_len_manual

grp_ict     = "ICT Zones (FVG/BPR)"
col_fvg     = input.color(color.new(#FFE66D, 75), "FVG Box (Gold)", group=grp_ict)
col_bpr     = input.color(color.new(#A855F7, 65), "BPR Box (Electric Purple)", group=grp_ict)
col_do      = input.color(#818CF8, "Daily Open (Indigo)", group=grp_ict)
// NEW: FVG Candle Colors
col_fvg_bull_candle = input.color(#FFD93D, "FVG Bull Candle (Gold)", group=grp_ict)
col_fvg_bear_candle = input.color(#FF8C42, "FVG Bear Candle (Orange)", group=grp_ict)

// ==========================================
// 1B. ORDER BLOCKS CONFIGURATION
// ==========================================
grp_ob      = "Order Blocks"
show_ob     = input.bool(true, "Show Order Blocks", group=grp_ob)
ob_lookback_manual = input.int(5, "OB Confirmation Candles (manual)", minval=1, maxval=20, group=grp_ob)
ob_proximity_pct = input.float(0.5, "OB Proximity to Liquidity (%)", minval=0.1, maxval=2.0, step=0.1, group=grp_ob, tooltip="OB must be within X% of a liquidity level to be displayed")
col_ob_bull = input.color(color.new(#38BDF8, 70), "Bullish OB Box (Sky Blue)", group=grp_ob)
col_ob_bear = input.color(color.new(#FB7185, 70), "Bearish OB Box (Pink Coral)", group=grp_ob)

ob_lookback = use_auto_params ? auto_ob_lookback : ob_lookback_manual

// ==========================================
// 1C. RISK MANAGEMENT CONFIGURATION
// ==========================================
grp_risk    = "Risk Management"
show_sltp   = input.bool(true, "Show SL/TP Levels", group=grp_risk)
atr_length  = input.int(14, "ATR Length", minval=1, group=grp_risk)
atr_sl_mult = input.float(1.5, "SL = ATR Ã—", minval=0.5, maxval=5.0, step=0.1, group=grp_risk)
rr_ratio    = input.float(2.0, "Risk:Reward Ratio", minval=1.0, maxval=5.0, step=0.5, group=grp_risk)
account_size = input.float(10000, "Account Size ($)", minval=100, group=grp_risk)
risk_percent = input.float(1.0, "Risk per Trade (%)", minval=0.1, maxval=10.0, step=0.1, group=grp_risk)

// ==========================================
// 1D. DASHBOARD CONFIGURATION
// ==========================================
grp_dash    = "Dashboard"
show_dashboard = input.bool(true, "Show Risk Dashboard", group=grp_dash)
dash_position = input.string("Top Right", "Position", options=["Top Right", "Top Left", "Bottom Right", "Bottom Left"], group=grp_dash)

// ==========================================
// 2. DAILY/WEEKLY OPEN (ADAPTATIF)
// ==========================================
reference_tf = is_position ? (tf_mins >= 10080 ? "M" : "W") : "D"
reference_label = is_position ? (tf_mins >= 10080 ? "Monthly Open" : "Weekly Open") : "Daily Open"

refOpen = request.security(syminfo.tickerid, reference_tf, open, lookahead=barmerge.lookahead_on)
plot(refOpen, "Reference Open Line", color=col_do, linewidth=2)

if barstate.islast
    label.new(bar_index + 3, refOpen, reference_label, color=color.new(col_do, 100), style=label.style_label_left, textcolor=col_do)

// ==========================================
// 3. LIQUIDITY LINES + TRACK LAST LEVELS
// ==========================================
ph = ta.pivothigh(high, liq_len, liq_len)
pl = ta.pivotlow(low, liq_len, liq_len)

// Store last BSL/SSL levels for OB filtering
var float last_bsl = na
var float last_ssl = na

if not na(ph)
    last_bsl := ph
    line.new(bar_index[liq_len], ph, bar_index + 10, ph, color=col_bsl, style=line.style_dotted)
    label.new(bar_index + 10, ph, "BSL", color=color.new(col_bsl, 100), textcolor=col_bsl, style=label.style_label_left, size=size.tiny)

if not na(pl)
    last_ssl := pl
    line.new(bar_index[liq_len], pl, bar_index + 10, pl, color=col_ssl, style=line.style_dotted)
    label.new(bar_index + 10, pl, "SSL", color=color.new(col_ssl, 100), textcolor=col_ssl, style=label.style_label_left, size=size.tiny)

// ==========================================
// 4. MARKET STRUCTURE (BOS WITH RECTANGLES)
// ==========================================
var float swing_high = na
var float swing_low = na

if not na(ph)
    swing_high := ph
if not na(pl)
    swing_low := pl

bos_bull = ta.crossover(close, swing_high)
bos_bear = ta.crossunder(close, swing_low)

// BOS Visual: Rectangle + Label (Dark Mode Optimized)
if bos_bull
    // Rectangle BOS Bull
    box.new(bar_index - 5, swing_high, bar_index, high, 
            bgcolor=color.new(col_bos_bull, 85), border_color=col_bos_bull, border_width=2,
            text="â¬† BOS", text_color=col_bos_bull, text_size=size.small)
    line.new(bar_index - 10, swing_high, bar_index, swing_high, color=col_bos_bull, width=2)

if bos_bear
    // Rectangle BOS Bear
    box.new(bar_index - 5, low, bar_index, swing_low, 
            bgcolor=color.new(col_bos_bear, 85), border_color=col_bos_bear, border_width=2,
            text="â¬‡ BOS", text_color=col_bos_bear, text_size=size.small)
    line.new(bar_index - 10, swing_low, bar_index, swing_low, color=col_bos_bear, width=2)

// ==========================================
// 5. ZONES (BPR & FVG) + CANDLE COLORING
// ==========================================
fvg_bull = low[0] > high[2]
fvg_bear = high[0] < low[2]

// *** NEW: Coloration des bougies FVG ***
barcolor(fvg_bull ? col_fvg_bull_candle : na, title="FVG Bull Candle")
barcolor(fvg_bear ? col_fvg_bear_candle : na, title="FVG Bear Candle")

bool bpr_bull = false
bool bpr_bear = false

if fvg_bull
    for i = 1 to 5
        if fvg_bear[i] and high[i] > low[0] and low[i+2] < high[2]
            bpr_bull := true
if fvg_bear
    for i = 1 to 5
        if fvg_bull[i] and low[i] < high[0] and high[i+2] > low[2]
            bpr_bear := true

// FVG/BPR Boxes
if bpr_bull
    box.new(bar_index[2], high[2], bar_index + 5, low[0], border_color=color.new(#A855F7, 50), bgcolor=col_bpr, text="BPR (+)", text_color=color.white, text_size=size.tiny)
else if fvg_bull
    box.new(bar_index[2], high[2], bar_index + 5, low[0], border_color=color.new(#FFE66D, 50), bgcolor=col_fvg, text="FVG", text_color=#FFE66D, text_size=size.tiny)

if bpr_bear
    box.new(bar_index[2], low[2], bar_index + 5, high[0], border_color=color.new(#A855F7, 50), bgcolor=col_bpr, text="BPR (-)", text_color=color.white, text_size=size.tiny)
else if fvg_bear
    box.new(bar_index[2], low[2], bar_index + 5, high[0], border_color=color.new(#FFE66D, 50), bgcolor=col_fvg, text="FVG", text_color=#FFE66D, text_size=size.tiny)

// ==========================================
// 6. ORDER BLOCKS - FILTERED BY LIQUIDITY ZONES
// ==========================================
is_bearish_candle = close[1] < open[1]
is_bullish_engulf = close > open and close > high[1]
ob_bull_detected = is_bearish_candle and is_bullish_engulf

is_bullish_candle = close[1] > open[1]
is_bearish_engulf = close < open and close < low[1]
ob_bear_detected = is_bullish_candle and is_bearish_engulf

// *** NEW: Filtrage OB par proximitÃ© aux zones de liquiditÃ© ***
ob_near_bsl = not na(last_bsl) and math.abs(close - last_bsl) / close * 100 < ob_proximity_pct
ob_near_ssl = not na(last_ssl) and math.abs(close - last_ssl) / close * 100 < ob_proximity_pct

// BOS lookback
bos_lookback = use_auto_params ? auto_bos_lookback : 8
recent_bos_bull = ta.barssince(bos_bull) < bos_lookback
recent_bos_bear = ta.barssince(bos_bear) < bos_lookback

// OB valide = proche d'une zone de liquiditÃ© OU confirmÃ© par BOS rÃ©cent
ob_bull_valid = ob_bull_detected and (ob_near_ssl or recent_bos_bull)
ob_bear_valid = ob_bear_detected and (ob_near_bsl or recent_bos_bear)

// Draw filtered OBs only
if show_ob and ob_bull_valid
    box.new(bar_index[1], high[1], bar_index + 10, low[1], 
            bgcolor=col_ob_bull, border_color=#38BDF8, border_width=2,
            text="OB âœ“", text_color=color.white, text_size=size.tiny)

if show_ob and ob_bear_valid
    box.new(bar_index[1], high[1], bar_index + 10, low[1], 
            bgcolor=col_ob_bear, border_color=#FB7185, border_width=2,
            text="OB âœ“", text_color=color.white, text_size=size.tiny)

// ==========================================
// 7. ATR & STOP LOSS / TAKE PROFIT
// ==========================================
atr_val = ta.atr(atr_length)
sl_distance = atr_val * atr_sl_mult
tp_distance = sl_distance * rr_ratio

var float current_entry = na
var float current_sl = na
var float current_tp1 = na
var float current_tp2 = na
var bool is_long = false

// ==========================================
// 8. STRATEGIE & SIGNAUX
// ==========================================
in_london = not na(time(timeframe.period, kz_london, "America/New_York"))
in_ny = not na(time(timeframe.period, kz_ny, "America/New_York"))
in_asia = use_asia_kz and not na(time(timeframe.period, kz_asia, "America/New_York"))

in_kz = is_position ? true : ((not useKZ) or in_london or in_ny or in_asia)

// --- BUY CONDITIONS ---
buy_cond = close < refOpen and in_kz and recent_bos_bull

entry_buy_ob = buy_cond and ob_bull_valid  // Use filtered OB
entry_buy_bpr = buy_cond and bpr_bull and not ob_bull_valid
entry_buy_fvg = buy_cond and fvg_bull and not bpr_bull and not ob_bull_valid

// --- SELL CONDITIONS ---
sell_cond = close > refOpen and in_kz and recent_bos_bear

entry_sell_ob = sell_cond and ob_bear_valid  // Use filtered OB
entry_sell_bpr = sell_cond and bpr_bear and not ob_bear_valid
entry_sell_fvg = sell_cond and fvg_bear and not bpr_bear and not ob_bear_valid

any_buy_signal = entry_buy_ob or entry_buy_bpr or entry_buy_fvg
any_sell_signal = entry_sell_ob or entry_sell_bpr or entry_sell_fvg

if any_buy_signal
    current_entry := close
    current_sl := close - sl_distance
    current_tp1 := close + sl_distance
    current_tp2 := close + tp_distance
    is_long := true

if any_sell_signal
    current_entry := close
    current_sl := close + sl_distance
    current_tp1 := close - sl_distance
    current_tp2 := close - tp_distance
    is_long := false

// --- SYMBOL RESTRICTION ---
s = syminfo.ticker
is_valid_pair = str.contains(s, "EURUSD") or str.contains(s, "GBPUSD")

if not is_valid_pair and barstate.islast
    label.new(bar_index, high, "âš ï¸ WRONG PAIR\nUse EURUSD or GBPUSD", color=#FF8C42, style=label.style_label_down, textcolor=color.white)

// Signal Shapes (Dark Mode Colors)
plotshape(is_valid_pair and entry_buy_ob, title="Buy OB", style=shape.labelup, location=location.belowbar, 
          color=#38BDF8, text="BUY\nOB", textcolor=color.white, size=size.normal)
plotshape(is_valid_pair and entry_sell_ob, title="Sell OB", style=shape.labeldown, location=location.abovebar, 
          color=#FB7185, text="SELL\nOB", textcolor=color.white, size=size.normal)

plotshape(is_valid_pair and entry_buy_bpr, title="Buy BPR", style=shape.labelup, location=location.belowbar, 
          color=#A855F7, text="BUY\nBPR", textcolor=color.white, size=size.small)
plotshape(is_valid_pair and entry_sell_bpr, title="Sell BPR", style=shape.labeldown, location=location.abovebar, 
          color=#A855F7, text="SELL\nBPR", textcolor=color.white, size=size.small)

plotshape(is_valid_pair and entry_buy_fvg, title="Buy FVG", style=shape.labelup, location=location.belowbar, 
          color=#00FF88, text="BUY\nFVG", textcolor=color.black, size=size.tiny)
plotshape(is_valid_pair and entry_sell_fvg, title="Sell FVG", style=shape.labeldown, location=location.abovebar, 
          color=#FF4757, text="SELL\nFVG", textcolor=color.white, size=size.tiny)

// SL/TP Levels
plot(show_sltp and any_buy_signal ? current_sl : na, "Buy SL", color=#FF4757, style=plot.style_cross, linewidth=2)
plot(show_sltp and any_buy_signal ? current_tp1 : na, "Buy TP1", color=#00FF88, style=plot.style_cross, linewidth=1)
plot(show_sltp and any_buy_signal ? current_tp2 : na, "Buy TP2", color=#4ECDC4, style=plot.style_cross, linewidth=2)

plot(show_sltp and any_sell_signal ? current_sl : na, "Sell SL", color=#FF4757, style=plot.style_cross, linewidth=2)
plot(show_sltp and any_sell_signal ? current_tp1 : na, "Sell TP1", color=#00FF88, style=plot.style_cross, linewidth=1)
plot(show_sltp and any_sell_signal ? current_tp2 : na, "Sell TP2", color=#4ECDC4, style=plot.style_cross, linewidth=2)

// ==========================================
// 9. SIGNAL STATISTICS
// ==========================================
stats_lookback = 100

var int total_ob_buy = 0
var int total_ob_sell = 0
var int total_bpr_buy = 0
var int total_bpr_sell = 0
var int total_fvg_buy = 0
var int total_fvg_sell = 0

if entry_buy_ob
    total_ob_buy += 1
if entry_sell_ob
    total_ob_sell += 1
if entry_buy_bpr
    total_bpr_buy += 1
if entry_sell_bpr
    total_bpr_sell += 1
if entry_buy_fvg
    total_fvg_buy += 1
if entry_sell_fvg
    total_fvg_sell += 1

recent_ob = math.sum(entry_buy_ob ? 1 : 0, stats_lookback) + math.sum(entry_sell_ob ? 1 : 0, stats_lookback)
recent_bpr = math.sum(entry_buy_bpr ? 1 : 0, stats_lookback) + math.sum(entry_sell_bpr ? 1 : 0, stats_lookback)
recent_fvg = math.sum(entry_buy_fvg ? 1 : 0, stats_lookback) + math.sum(entry_sell_fvg ? 1 : 0, stats_lookback)

london_signals = math.sum((any_buy_signal or any_sell_signal) and in_london ? 1 : 0, stats_lookback)
ny_signals = math.sum((any_buy_signal or any_sell_signal) and in_ny ? 1 : 0, stats_lookback)

// ==========================================
// 10. DASHBOARD (Dark Mode Optimized)
// ==========================================
GetTrend(tf) =>
    ema50 = ta.ema(close, 50)
    c = close
    [ema50, c]

[h1_ema, h1_close] = request.security(syminfo.tickerid, "60", GetTrend("60"), lookahead=barmerge.lookahead_on)
[h4_ema, h4_close] = request.security(syminfo.tickerid, "240", GetTrend("240"), lookahead=barmerge.lookahead_on)

h1_bull = h1_close > h1_ema
h4_bull = h4_close > h4_ema

if show_dashboard and barstate.islast
    risk_amount = account_size * (risk_percent / 100)
    sl_pips = sl_distance / syminfo.mintick
    position_size = risk_amount / sl_distance
    
    tf_type = is_scalping ? "Scalping" : is_intraday ? "Intraday" : is_swing ? "Swing" : "Position"
    
    table_pos = dash_position == "Top Right" ? position.top_right :
                dash_position == "Top Left" ? position.top_left :
                dash_position == "Bottom Right" ? position.bottom_right :
                position.bottom_left
    
    var table dash = table.new(table_pos, 2, 10, 
                               bgcolor=color.new(#1a1a2e, 10), 
                               border_color=#4a4a6a, border_width=1)
    
    table.cell(dash, 0, 0, "ðŸ“Š ICT RISK MANAGER", text_color=#4ECDC4, text_size=size.small)
    table.merge_cells(dash, 0, 0, 1, 0)
    
    table.cell(dash, 0, 1, "Mode", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 1, tf_type + " (" + timeframe.period + ")", text_color=#818CF8, text_size=size.tiny)
    
    table.cell(dash, 0, 2, "H1 Trend", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 2, h1_bull ? "ðŸŸ¢ BULL" : "ðŸ”´ BEAR", text_color=h1_bull ? #00FF88 : #FF4757, text_size=size.tiny)

    table.cell(dash, 0, 3, "H4 Trend", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 3, h4_bull ? "ðŸŸ¢ BULL" : "ðŸ”´ BEAR", text_color=h4_bull ? #00FF88 : #FF4757, text_size=size.tiny)

    table.cell(dash, 0, 4, "Reference", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 4, reference_label, text_color=#818CF8, text_size=size.tiny)
    
    table.cell(dash, 0, 5, "ATR (" + str.tostring(atr_length) + ")", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 5, str.tostring(atr_val, "#.#####"), text_color=#FFE66D, text_size=size.tiny)
    
    table.cell(dash, 0, 6, "SL Distance", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 6, str.tostring(sl_distance, "#.#####"), text_color=#FF4757, text_size=size.tiny)
    
    table.cell(dash, 0, 7, "TP Distance", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 7, str.tostring(tp_distance, "#.#####"), text_color=#00FF88, text_size=size.tiny)
    
    table.cell(dash, 0, 8, "Risk $", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 8, "$" + str.tostring(risk_amount, "#.##"), text_color=#FF8C42, text_size=size.tiny)
    
    table.cell(dash, 0, 9, "Position Size", text_color=#888888, text_size=size.tiny)
    table.cell(dash, 1, 9, str.tostring(position_size, "#.###") + " units", text_color=#4ECDC4, text_size=size.tiny)
    
    // Stats Table
    stats_table_pos = dash_position == "Top Right" ? position.top_left :
                      dash_position == "Top Left" ? position.top_right :
                      dash_position == "Bottom Right" ? position.bottom_left :
                      position.bottom_right
    
    var table stats = table.new(stats_table_pos, 3, 7, 
                                bgcolor=color.new(#1a1a2e, 10), 
                                border_color=#4a4a6a, border_width=1)
    
    table.cell(stats, 0, 0, "ðŸ“ˆ SIGNAL STATS", text_color=#4ECDC4, text_size=size.small)
    table.merge_cells(stats, 0, 0, 2, 0)
    
    table.cell(stats, 0, 1, "Type", text_color=#888888, text_size=size.tiny)
    table.cell(stats, 1, 1, "Recent", text_color=#888888, text_size=size.tiny)
    table.cell(stats, 2, 1, "Total", text_color=#888888, text_size=size.tiny)
    
    table.cell(stats, 0, 2, "ðŸ”· OB", text_color=#38BDF8, text_size=size.tiny)
    table.cell(stats, 1, 2, str.tostring(recent_ob), text_color=color.white, text_size=size.tiny)
    table.cell(stats, 2, 2, str.tostring(total_ob_buy + total_ob_sell), text_color=color.white, text_size=size.tiny)
    
    table.cell(stats, 0, 3, "ðŸŸ£ BPR", text_color=#A855F7, text_size=size.tiny)
    table.cell(stats, 1, 3, str.tostring(recent_bpr), text_color=color.white, text_size=size.tiny)
    table.cell(stats, 2, 3, str.tostring(total_bpr_buy + total_bpr_sell), text_color=color.white, text_size=size.tiny)
    
    table.cell(stats, 0, 4, "ðŸŸ¡ FVG", text_color=#FFE66D, text_size=size.tiny)
    table.cell(stats, 1, 4, str.tostring(recent_fvg), text_color=color.white, text_size=size.tiny)
    table.cell(stats, 2, 4, str.tostring(total_fvg_buy + total_fvg_sell), text_color=color.white, text_size=size.tiny)
    
    table.cell(stats, 0, 5, "ðŸ‡¬ðŸ‡§ London", text_color=#818CF8, text_size=size.tiny)
    table.cell(stats, 1, 5, str.tostring(london_signals), text_color=color.white, text_size=size.tiny)
    table.cell(stats, 2, 5, "-", text_color=#888888, text_size=size.tiny)
    
    table.cell(stats, 0, 6, "ðŸ‡ºðŸ‡¸ New York", text_color=#FF8C42, text_size=size.tiny)
    table.cell(stats, 1, 6, str.tostring(ny_signals), text_color=color.white, text_size=size.tiny)
    table.cell(stats, 2, 6, "-", text_color=#888888, text_size=size.tiny)

// ==========================================
// 11. ALERTS
// ==========================================
alertcondition(entry_buy_ob, "ENTRY BUY OB", "ðŸ”µ High Probability Buy (Order Block) Detected!")
alertcondition(entry_sell_ob, "ENTRY SELL OB", "ðŸ”´ High Probability Sell (Order Block) Detected!")
alertcondition(entry_buy_bpr, "ENTRY BUY BPR", "ðŸŸ¢ Buy Signal (BPR) Detected")
alertcondition(entry_sell_bpr, "ENTRY SELL BPR", "ðŸ”´ Sell Signal (BPR) Detected")
alertcondition(entry_buy_fvg, "ENTRY BUY FVG", "ðŸŸ¢ Buy Signal (FVG) Detected")
alertcondition(entry_sell_fvg, "ENTRY SELL FVG", "ðŸ”´ Sell Signal (FVG) Detected")
alertcondition(any_buy_signal, "ANY BUY SIGNAL", "ðŸ“ˆ Buy Signal Detected")
alertcondition(any_sell_signal, "ANY SELL SIGNAL", "ðŸ“‰ Sell Signal Detected")

// ==========================================
// 12. DYNAMIC ALERTS (JSON)
// ==========================================
if any_buy_signal or any_sell_signal
    sig_type = entry_buy_ob or entry_sell_ob ? "OB" : 
               entry_buy_bpr or entry_sell_bpr ? "BPR" : "FVG"
    sig_session = in_london ? "LONDON" : in_ny ? "NEW_YORK" : in_asia ? "ASIAN" : "OTHER"
    
    json_alert = '{"date": "' + str.format_time(time, "yyyy-MM-dd'T'HH:mm", syminfo.timezone) + '",' +
                 '"symbol": "' + syminfo.ticker + '",' +
                 '"direction": "' + (is_long ? "BUY" : "SELL") + '",' +
                 '"signalType": "' + sig_type + '",' +
                 '"entryPrice": ' + str.tostring(current_entry) + ',' +
                 '"stopLoss": ' + str.tostring(current_sl) + ',' +
                 '"takeProfit": ' + str.tostring(current_tp2) + ',' +
                 '"session": "' + sig_session + '",' +
                 '"timeframe": "' + timeframe.period + '"}'
    
    alert(json_alert, alert.freq_once_per_bar_close)